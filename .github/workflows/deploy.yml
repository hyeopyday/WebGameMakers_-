name: Deploy Vite â†’ Nginx (via ~/frontEnd)

on:
  push:
    branches: [ "main" ]

jobs:
  deploy-vite:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: web

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install & Build (Vite)
        run: |
          npm ci
          npm run build   # => dist/

      - name: Prepare SSH
        run: |
          set -e

          # 0) ê¸°ë³¸ í¬íŠ¸ fallback (ë¹„ì–´ìžˆìœ¼ë©´ 22)
          PORT="${{ secrets.RASP_PORT }}"
          if [ -z "$PORT" ]; then PORT=22; fi

          # 1) ê°œì¸í‚¤ ì €ìž¥ (ì¤„ë°”ê¿ˆ ë³´ì¡´)
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.RASP_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519

          # 2) known_hosts ë“±ë¡ (í¬íŠ¸ ì§€ì • + ì‹¤íŒ¨í•´ë„ ë¹Œë“œ ì¤‘ë‹¨ X)
          (ssh-keyscan -p "$PORT" -H "${{ secrets.RASP_HOST }}" 2>/dev/null >> ~/.ssh/known_hosts) || true

          # 3) SSH config ìž‘ì„±(í˜¸ìŠ¤íŠ¸ë³„ ì„¤ì •) â†’ ì´í›„ë¶€í„°ëŠ” 'ssh deploy_target'ë¡œ ì ‘ì† ê°€ëŠ¥
          cat > ~/.ssh/config <<EOF
          Host deploy_target
              HostName ${{ secrets.RASP_HOST }}
              User ${{ secrets.RASP_USER }}
              Port $PORT
              IdentityFile ~/.ssh/id_ed25519
              IdentitiesOnly yes
              StrictHostKeyChecking accept-new
          EOF
              chmod 600 ~/.ssh/config

      # 1) ì›ê²©: ~/frontEnd ë¥¼ ë§¤ë²ˆ ì´ˆê¸°í™”
      - name: Clean ~/frontEnd on server
        run: |
          PORT="${{ secrets.RASP_PORT }}"
          ssh -p "$PORT" ${{ secrets.RASP_USER }}@${{ secrets.RASP_HOST }} '
            set -e
            TARGET="$HOME/frontEnd"
            rm -rf "$TARGET" && mkdir -p "$TARGET"
          '

      # 2) dist â†’ ì›ê²©ì˜ ~/frontEnd ë¡œ ì—…ë¡œë“œ
      - name: Upload dist â†’ ~/frontEnd
        run: |
          rsync -az --delete -e "ssh -p ${{ secrets.RASP_PORT }}" ./dist/ \
            ${{ secrets.RASP_USER }}@${{ secrets.RASP_HOST }}:~/frontEnd/

      # 3) ~/frontEnd ë‚´ìš©ì„ Nginx ë£¨íŠ¸ë¡œ ë°˜ì˜(+ ìž¬ì‹œìž‘)
      - name: Deploy to Nginx root & reload
        run: |
          PORT="${{ secrets.RASP_PORT }}"
          # ðŸ”§ í•„ìš”í•˜ë©´ ì—¬ê¸° ê²½ë¡œë§Œ ë°”ê¿”: /var/www/html ë˜ëŠ” /var/www/viteapp ë“±
          NGINX_ROOT="/var/www/frontEnd"

          ssh -p "$PORT" ${{ secrets.RASP_USER }}@${{ secrets.RASP_HOST }} "
            set -e
            sudo mkdir -p \"$NGINX_ROOT\"
            sudo rsync -a --delete \"\$HOME/frontEnd/\" \"$NGINX_ROOT/\"
            sudo systemctl reload nginx || sudo systemctl restart nginx
          "
